<?
$g = $_GET['game'] == '' ? 'pk10' : $_GET['game'];

switch($g){
    case 'pk10': $game = '北京赛车'; break;
    case 'xyft': $game = '幸运飞艇'; break;
	case 'cqssc': $game = '重庆时时彩'; break;
	case 'jssc': $game = '极速赛车'; break;
	case 'jssm': $game = '极速赛马'; break;
	case 'jsmt': $game = '极速摩托'; break;
	case 'jsssc': $game = '极速时时彩'; break;
    case 'lhc': $game = '六合彩'; break;
    case 'jslhc': $game = '极速六合彩'; break;
    case 'txffc': $game = '腾讯分分彩'; break;
	case 'azxy10': $game = '澳洲幸运十'; break;
	case 'azxy5': $game = '河内5分彩'; break;
	case 'bjl': $game = '百家乐'; break;
	case 'xy28': $game = '新加坡28'; break;
	case 'ny28': $game = '纽约28'; break;
	case 'jnd28': $game = '加拿大28'; break;
	case 'kuai3': $game = '江苏快三'; break;
	case 'twk3': $game = '台湾快三'; break;
	case 'gd11x5': $game = '广东11选5'; break;
}
?>
<link rel="stylesheet" href="plugins/datatables/dataTables.bootstrap.css">
<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <h1>
            下注监控<small>聊天管理</small>
        </h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i> 控制台</a></li>
            <li><a href="#"> 聊天管理</a></li>
            <li class="active">下注监控</li>
        </ol>
    </section>

    <!-- Main content -->
    <section class="content">
        <div class="box box-info">
            <div class="box-header">
                <h3 class="box-title"></h3>
                <div class="btn-group">
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=pk10'" type="button" class="btn btn-danger btn-xs">北京赛车</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=xyft'" type="button" class="btn btn-danger btn-xs">幸运飞艇</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=cqssc'" type="button" class="btn btn-danger btn-xs">重庆时时彩</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=jssc'" type="button" class="btn btn-danger btn-xs">极速赛车</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=jssm'" type="button" class="btn btn-danger btn-xs">极速赛马</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=jsmt'" type="button" class="btn btn-danger btn-xs">极速摩托</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=jsssc'" type="button" class="btn btn-danger btn-xs">极速时时彩</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=lhc'" type="button" class="btn btn-danger btn-xs">六合彩</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=jslhc'" type="button" class="btn btn-danger btn-xs">极速六合彩</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=txffc'" type="button" class="btn btn-danger btn-xs">腾讯分分彩</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=azxy10'" type="button" class="btn btn-danger btn-xs">澳洲幸运十</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=azxy5'" type="button" class="btn btn-danger btn-xs">河内5分彩</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=bjl'" type="button" class="btn btn-danger btn-xs">百家乐</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=xy28'" type="button" class="btn btn-danger btn-xs">新加坡28</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=ny28'" type="button" class="btn btn-danger btn-xs">纽约28</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=jnd28'" type="button" class="btn btn-danger btn-xs">加拿大28</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=kuai3'" type="button" class="btn btn-danger btn-xs">江苏快三</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=twk3'" type="button" class="btn btn-danger btn-xs">台湾快三</button>
                    <button onclick="window.location.href='index.php?m=chat&c=room&game=gd11x5'" type="button" class="btn btn-danger btn-xs">广东11选5</button>
                </div>
                <div class="box-tools pull-right">
                    <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-9">
                <div class="box box-success direct-chat direct-chat-success">
                    <div class="box-header with-border">
                        <h3 class="box-title">房间聊天</h3>

                        <div class="box-tools pull-right">
                            <span data-toggle="tooltip" title="本期共收到3条投注消息" class="badge bg-green">3</span>
                            <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                            <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                        </div>
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body">
                        <!-- Conversations are loaded here -->
                        <div class="direct-chat-messages" id="messages" style="height:550px;">

                        </div>
                        <!--/.direct-chat-messages-->
                    </div>
                    <!-- /.box-body -->
                    <div class="box-footer">
                        <div class="input-group">
                            <input type="text" id="sendmsg" name="message" placeholder="发送消息 ..." class="form-control">
                            <span class="input-group-btn">
                        <button onclick="sendmsg()" class="btn btn-success btn-flat">发送</button>
                      </span>
                        </div>
                    </div>
                    <!-- /.box-footer-->
                </div>
            </div>
            <div class="col-md-3">
                <div class="box box-warning box-solid">
                    <div class="box-header">
                        <h3 class="box-title">开奖管理</h3>
                    </div>
                    <div class="box-body">
                        <label>当前彩种:</label><span><? echo $game; ?></span><br/>
                        <label>当前期号:</label><span id="term">000期</span><br/>
                        <label>开奖号码:</label><span id="opencode">01,02,03,04,05,06,07,08,09,10</span><br/>
                        <label>距离下期开奖:</label><span style="font-size:20px;font-weight:bold;color:cornflowerblue;" id="time">00秒</span>
                    </div>
                </div>
                <div class="box box-danger box-solid">
                    <div class="box-header">
                        <h3 class="box-title">在线人员</h3>

                        <div class="box-tools pull-right">
                            <button href="#" class="btn btn-box-tool" data-toggle="tooltip" data-title="每把封盘后会刷新对应余额" data-placement="left"><i class="fa fa-question-circle"></i></a>
                        </div>
                    </div>
                    <div class="box-body">
                        <table class="table table-bordered table-striped" id="tableList">
                            <thead>
                            <tr>
                                <th>昵称</th>
                                <th>余额</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- /.content -->
</div>
<script src="plugins/datatables/jquery.dataTables.min.js"></script>
<script src="plugins/datatables/dataTables.bootstrap.min.js"></script>
<script>
    var id = 0;
    var game = '<? echo $g; ?>';
    var first = true;
    var time = 0;
    var roomid='<? echo $roomid; ?>'
    var userid="<? echo $roomid; ?>admin"

    getgame();
    tablestart();
    $(document).ready(function () {
        var myURL = parseURL(window.location.href);
        console.log(myURL.host)
        url = "ws://"+myURL.host+":8653/chat/"+roomid+"/" + game + "/" + userid;
        connect(url,0)
    });

    function sendmsg(){
        var content = $('#sendmsg').val();
        $.ajax({
            url: 'Application/ajax_chat.php?type=send&game=' + game,
            type: 'post',
            data: {content: content},
            dataType: 'json',
            success: function(data){
                alert('发送成功');
                $('#sendmsg').val('');
            }
        })
    }


    function addMessage(data) {
        if (data == null || data.length < 0) {
            return;
        }
        //S1代理  S2待定  S3机器人  S4全局公告
        var str = "";
        for (i = 0; i < data.length; i++) {
            if (parseInt(data[i].id) > id) {
                id = data[i].id;
            }
            var type = data[i].type;
            if (type.substr(0, 1) == 'U') {
                str = str + '<div class="direct-chat-msg">'
                    + '<div class="direct-chat-info clearfix">'
                    + '<span class="direct-chat-name pull-left">'  + data[i].nickname + '</span>'
                    + '<span class="direct-chat-timestamp pull-right">' + data[i].addtime + '</span>'
                    + '</div>'
                    + '<img class="direct-chat-img" src="' + data[i].headimg + '" alt="message user image">'
                    + '<div class="direct-chat-text">' + data[i].content + '</div></div>';


            } else if (type == 'S3') {
                var headimg = data[i].headimg == "" ? "/Style/images/robot.png" : data[i].headimg;
                str = str + '<div class="direct-chat-msg right">'
                    + '<div class="direct-chat-info clearfix">'
                    + '<span class="direct-chat-name pull-right">' + data[i].nickname + '</span>'
                    + '<span class="direct-chat-timestamp pull-left">' + data[i].addtime + '</span>'
                    + '</div>'
                    + '<img class="direct-chat-img" src="' + headimg + '" alt="message user image">'
                    + '<div class="direct-chat-text">' + data[i].content + '</div></div>'
            } else if (type == 'S1') {
                var headimg = data[i].headimg == "" ? "/Style/images/Sys.png" : data[i].headimg;
                str = str + '<div class="direct-chat-msg right">'
                    + '<div class="direct-chat-info clearfix">'
                    + '<span class="direct-chat-name pull-right">'  + data[i].nickname + '</span>'
                    + '<span class="direct-chat-timestamp pull-left">' + data[i].addtime + '</span>'
                    + '</div>'
                    + '<img class="direct-chat-img" src="' + headimg + '" alt="message user image">'
                    + '<div class="direct-chat-text">' + data[i].content + '</div></div>'
            }
        }
        $('#messages').prepend(str);
    }
    function getgame(){
        $.ajax({
            url: 'Application/ajax_getcode.php?g=' + game,
            type: 'get',
            dataType:'json',
            success: function(data){
                $('#term').text(data.term + '期');
                $('#opencode').text(data.code);
                time = data.time;
                if(first){
                    gotime();
                    first = false;
                }
            },
            error: function() { }
        });
    }
    function gotime(){
        time = time - 1;
        if(time < 0){
            getgame();
            $('#time').text('开奖中...');
            setTimeout(function() {
                gotime();
                tablestart();
            }, 5000);
            return;
        }

        $('#time').text(time + '秒');
        setTimeout(function() {
            gotime();
        }, 1000);
    }

    function tablestart(){
        $('#tableList').DataTable({
            "destroy": true,
            "searching":false,
            "scrollX": true,
            "lengthChange": false,
            "ajax":{
                "url": "Application/ajax_getonline.php",
                "dataSrc":function(json){
                    if(json.data[0] == 'null'){
                        return json;
                    }
                    for(var i=0;i<json.data.length; i++){
                        json.data[i][2] = "<a href='javascript:ban(\"" + json.data[i][2] + "\")' class='btn btn-danger btn-xs'>禁言玩家</a>";
                    }
                    return json.data;
                }
            }
        });
    }

    function ban(id){
        $.ajax({
            url:'Application/ajax_banuser.php',
            type: 'post',
            data: {id: id},
            dataType: 'json',
            success: function( data ){
                if(data.success){
                    alert('禁言成功..');
                }else{
                    alert(data.msg);
                }
            },
            error: function() { }
        })
    }

    function connect(url,delay) {
        if(lockReconnect) {
            return;
        };
        lockReconnect = true;
        //没连接上会一直重连，设置延迟避免请求过多
        clearTimeout(delayRun)
        setTimeout(function () {
            createWebSocket(url);
        },delay);
    }

    function createWebSocket() {
        //判断当前浏览器是否支持WebSocket
        if('WebSocket' in window){
            websocket = new WebSocket(url);
        }
        else{
            alert('当前浏览器不支持，请更换浏览器')
        }

        //连接发生错误的回调方法
        websocket.onerror = function(){
            // setMessageInnerHTML("error");
            console.log(' onerror');
        };

        //连接成功建立的回调方法
        websocket.onopen = function(){
            //setMessageInnerHTML("open");
            console.log(" Socket is On");
            //心跳检测重置
            websocket.send('heartbeat');

            $('#messages').html("");

        }

        //接收到消息的回调方法
        websocket.onmessage = function(event){
            // 维持心跳
            console.log("onmessage==>"+event.data)

            if(event.data ==='heartbeat'){
                setTimeout(function(){
                    //这里发送一个心跳，后端收到后，返回一个心跳消息，
                    //onmessage拿到返回的心跳就说明连接正常
                    websocket.send('heartbeat');
                }, 5000)
            }else
            {
                var jsonOBJ=JSON.parse(event.data);
                if(jsonOBJ!=null && jsonOBJ!=undefined)
                {
                    if(jsonOBJ.datas.betTerm!=null)
                    {
                        if(info!=undefined && info!=null)
                        {
                            if(jsonOBJ.datas.betTerm!==undefined && jsonOBJ.datas.betTerm!=='' && jsonOBJ.datas.betTerm!==null && parseInt(nowTerm) < parseInt(jsonOBJ.datas.betTerm))
                            {
                                nowTerm=jsonOBJ.datas.betTerm;
                            }
                        }

                    }

                    addMessage(jsonOBJ.datas.list);
                }
            }
        }

        //连接关闭的回调方法
        websocket.onclose = function(){
            // websocket.setMessageInnerHTML("close");
            console.log(" Socket closed");
            lockReconnect = false;
            connect(url,5000);
        }
    }

    function parseURL(url) {
        var a = document.createElement('a');
        a.href = url;
        return {
            source: url,
            protocol: a.protocol.replace(':', ''),
            host: a.hostname,
            port: a.port,
            query: a.search,
            params: (function () {
                var ret = {},
                    seg = a.search.replace(/^\?/, '').split('&'),
                    len = seg.length, i = 0, s;
                for (; i < len; i++) {
                    if (!seg[i]) {
                        continue;
                    }
                    s = seg[i].split('=');
                    ret[s[0]] = s[1];
                }
                return ret;
            })(),
            file: (a.pathname.match(/\/([^\/?#]+)$/i) || [, ''])[1],
            hash: a.hash.replace('#', ''),
            path: a.pathname.replace(/^([^\/])/, '/$1'),
            relative: (a.href.match(/tps?:\/\/[^\/]+(.+)/) || [, ''])[1],
            segments: a.pathname.replace(/^\//, '').split('/')
        };
    }
</script>
</script>